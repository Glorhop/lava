#!/bin/bash

set -x
set -e

PEP8=1
PYTEST=0
ALL=1

while getopts ":pya" opt; do
  case $opt in
    p)
      # pep8 only
      PEP8=2
      ;;
    y)
      # use py.test
      PYTEST=1
      ;;
    a)
      # python3 - python2 support dropped
      ALL=1
      ;;
    \?)
      echo "Usage:"
      echo "-p - pep8 only"
      echo "-y - use py.test"
      echo "-a - run all tests: pep8 and python3"
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

shift $((OPTIND -1))

pep8 --ignore E501,E722 .

if [ ${PEP8} = 2 ]; then
    exit 0
fi

echo "Removing old .pyc files"
echo
find . -name '*.pyc' -delete
rm -rf ./.cache/
rm -rf ./__init__.py

echo "Starting unit tests"
echo

if [ -z "$1" ] || [ "$1" == "--noinput" ]; then
  echo "If it exists, a broken test database will be deleted without prompting."
  NOINPUT='--noinput -v2'
fi

if [[ (-z "$1") || (("$1" == -v*) && ($# -eq 1)) ]]; then
  VERBOSE=$1
fi

if [ ${ALL} = 1 ]; then
  if [ -n "$NOINPUT" ] || [ -n "$VERBOSE" ]; then
    python3 ./lava_server/manage.py test $NOINPUT $VERBOSE \
    lava_scheduler_app \
    linaro_django_xmlrpc.tests \
    lava_results_app
  else
    python3 ./lava_server/manage.py test "$@"
  fi

  if [ ${PYTEST} = 1 ]; then
    py.test-3 -v lava_dispatcher/test
  else
    python3 -m unittest discover -v lava_dispatcher/test
  fi
fi
